<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8" />
    <title>Ejercicio Listado Personas. AJAX</title>
    <style type="text/css">
        fieldset {
            width: 20%;
        }

        #editarUsuario {
            visibility: hidden;
        }

        #eliminar {
            background-color: pink;
            font-weight: bold;
        }
    </style>
    <script src="../utilPOST.js" type="text/javascript"></script>
    <script type="text/javascript">
        window.onload = () => {
            petiPOST("servidor.php", LISTAR, mostrarTabla);
            document.getElementById("btAnade").onclick = nuevaPersona;
        }
        const LISTAR = { servicio: "listar" }
        const URL = "servidor.php";
        var oRes = null;

        function nuevaPersona(e) {
            var p = {
                servicio: "insertar",
                dni: document.getElementById("dni").value,
                nombre: document.getElementById("nombre").value,
                apellidos: document.getElementById("apellidos").value
            }
            petiPOST(URL, p, respuestaInsertar);
            petiPOST(URL, LISTAR, mostrarTabla);
        }

        function borrarPersona() {
            this.parentNode.parentNode.className = "eliminar";
            setTimeout(() => {
                if (confirm("¿Estas seguro que lo deseas eliminar?")) {
                    var p = {
                        servicio: "borrar",
                        id: this.dataset.idPersona
                    }
                    petiPOST(URL, p);
                    petiPOST(URL, LISTAR, mostrarTabla);
                }
                this.parentNode.parentNode.className = "";
            }, 100);
        }


        function editarPersona() {
            var buscarP = {
                servicio: "selPersonaID",
                id: this.dataset.idPersona
            };
            document.getElementById("editarUsuario").setAttribute("style", "visibility:visible");
            petiPOST(URL, buscarP);
            document.getElementById("dniMod").value = oRes.DNI;
            document.getElementById("nombreMod").value = oRes.DNI;
            document.getElementById("apellidosMod").value = oRes.DNI;
            //   if (document.getElementById("btCancelar").onclick)
            //     console.log("bien")
            //document.getElementById("editarUsuario").setAttribute("style", "visibility:hidden");
        }

        function mostrarTabla(datos) {
            oRes = datos;
            document.getElementById("filas_tabla").innerHTML = " ";

            oRes.forEach(function (o) {
                var tr = document.createElement("tr");
                tr.appendChild(llenarFila(o.ID));
                tr.appendChild(llenarFila(o.DNI));
                tr.appendChild(llenarFila(o.NOMBRE));
                tr.appendChild(llenarFila(o.APELLIDOS));
                tr.appendChild(llenarFila(o.ID, "BORRAR"));
                tr.appendChild(llenarFila(o.ID, "EDITAR"));
                document.getElementById("filas_tabla").appendChild(tr);
            });
        }

        function llenarFila(datos, tipo = "") {
            var td = document.createElement("td");
            var boton = document.createElement("button");
            switch (tipo) {
                case "BORRAR":
                    boton.innerHTML = "Borrar"
                    boton.dataset.idPersona = datos;
                    boton.onclick = borrarPersona;
                    td.appendChild(boton);
                    break;
                case "EDITAR":
                    boton.innerHTML = "Editar"
                    boton.dataset.idPersona = datos;
                    boton.onclick = editarPersona;
                    td.appendChild(boton);
                    break;
                default:
                    datos = document.createTextNode(datos);
                    td.appendChild(datos);
            }
            return td;
        }

    </script>
</head>

<body>
    <h1>Registro de Usuarios</h1>

    <form id="nuevoUsuario">
        <fieldset>
            <legend>Nuevo usuario </legend>
            <label for="dni">DNI:</label>
            <input type="text" id="dni" name="dni" value="15404252W" />
            <span id="infoDNI"> </span>
            <br />
            <label for="nombre">NOMBRE:</label>
            <input type="text" id="nombre" name="nombre" value="Miguel Angel" />
            <br />
            <label for="apellidos">APELLIDOS:</label>
            <input type="text" id="apellidos" name="apellidos" value="Martin Martin" />
            <br />
            <input type="button" value="Añadir" id="btAnade" />
        </fieldset>
    </form>

    <br />

    <table id="tabla_personas" border="1">
        <tr>
            <th>ID</th>
            <th>DNI</th>
            <th>NOMBRE</th>
            <th>APELLIDOS</th>
            <th>Eliminar</th>
            <th>Modificar</th>
        </tr>
        <tbody id="filas_tabla">

        </tbody>
    </table>

    <form id="editarUsuario">
        <fieldset>
            <legend>Editar usuario </legend>
            <label for="dni">DNI:</label>
            <input type="text" id="dniMod" name="dniMod" />
            <span id="infoDNI"> </span>
            <br />
            <label for="nombre">NOMBRE:</label>
            <input type="text" id="nombreMod" name="nombreMod" />
            <br />
            <label for="apellidos">APELLIDOS:</label>
            <input type="text" id="apellidosMod" name="apellidosMod" />
            <br />
            <input type="button" value="Confirmar" id="btAnade" />
            <input type="button" value="Cancelar" id="btCancelar" />
        </fieldset>
    </form>

</body>

</html>